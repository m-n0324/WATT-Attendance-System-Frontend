<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Interface</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <style>
    main {
      padding: 20px;
    }

    .table-responsive {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <main class="container-fluid">
    <div class="table-responsive">
      <table id="studentTable" class="table table-bordered table-hover align-middle shadow-sm">
        <thead class="table-dark text-center">
          <tr>
            <th>Sno.</th>
            <th>Student Name</th>
            <th>Class</th>
            <th>Section</th>
            <th>Date of Birth</th>
            <th>Contact</th>
            <th>Address</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="studentTableBody">
          </tbody>
      </table>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const studentTableBody = document.getElementById('studentTableBody');
    let allStudents = [];

    function loadStudents() {
      allStudents = JSON.parse(localStorage.getItem('students')) || [];
      renderStudents(allStudents);
    }

    function renderStudents(studentsToDisplay) {
      studentTableBody.innerHTML = '';
      if (studentsToDisplay.length === 0) {
        studentTableBody.innerHTML = <tr><td colspan="8" class="text-center text-muted">No students found.</td></tr>;
        return;
      }

      studentsToDisplay.forEach((s, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td>
            <a href="#" class="text-decoration-none text-dark">${s.fullName}</a>
          </td>
          <td class="text-center">${s.class}</td>
          <td class="text-center">${s.section}</td>
          <td class="text-center">${s.dob}</td>
          <td class="text-center">${s.contact || s.fatherMobile || ''}</td>
          <td class="text-center">${s.address}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-danger me-1" onclick="deleteStudent('${s.studentId}')">Delete</button>
            <button class="btn btn-sm btn-warning" onclick="editStudent('${s.studentId}')">Edit</button>
          </td>
        `;

        tr.querySelector('td a').addEventListener('click', function(e) {
          e.preventDefault();
          localStorage.setItem('currentStudent', JSON.stringify(s));
          window.parent.postMessage({ type: 'updateTitle', title: 'Student Details', showBack: true }, '*');
          window.parent.loadIframe('studentDetails.html?id=' + s.studentId);
        });

        studentTableBody.appendChild(tr);
      });
    }

    // Is code ko maine add kiya hai index.html se messages receive karne ke liye
    window.addEventListener('message', function(event) {
        const data = event.data;
        if (data.type === 'filterStudents') {
            const { searchClass, searchSection } = data;
            const filteredStudents = allStudents.filter(s =>
                (searchClass === '' || s.class.toLowerCase().includes(searchClass.toLowerCase())) &&
                (searchSection === '' || s.section.toLowerCase().includes(searchSection.toLowerCase()))
            );
            renderStudents(filteredStudents);
        } else if (data.type === 'resetStudents') {
            loadStudents();
        }
    });

    function deleteStudent(id) {
      let students = JSON.parse(localStorage.getItem('students')) || [];
      students = students.filter(s => s.studentId !== id);
      localStorage.setItem('students', JSON.stringify(students));
      loadStudents();
    }

    function editStudent(id) {
      let students = JSON.parse(localStorage.getItem('students')) || [];
      const student = students.find(s => s.studentId === id);
      if (student) {
        localStorage.setItem('currentStudent', JSON.stringify(student));
        window.parent.postMessage({ type: 'updateTitle', title: 'Edit Student', showBack: true }, '*');
        window.location.href = 'addNewStudent.html?id=' + id + '&edit=1';
      }
    }

    document.addEventListener("DOMContentLoaded", loadStudents);
  </script>
</body>

</html>