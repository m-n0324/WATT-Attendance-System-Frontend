<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WATT Attendance - Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <style>
    /* Active sidebar link highlight */
    .active-link {
      background-color: #495057;
      color: #fff !important;
      border-radius: 0.25rem 0 0 0.25rem;
    }

    .nav-link-item:hover {
      background-color: #6c757d;
      color: #fff !important;
    }

    iframe {
      border: none;
    }

    /* Back button container */
    #backButtonContainer {
      display: none;
      margin: 0 1rem 1rem 1rem;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row min-vh-100">

      <div class="col-12 col-md-3 col-lg-2 bg-dark text-white d-flex flex-column justify-content-between pe-0 position-sticky top-0" style="height: 100vh;">
        <div>
          <nav class="navbar bg-dark border-bottom border-white mb-3" data-bs-theme="dark">
            <a class="navbar-brand text-white" href="#" onclick="loadIframe('dashboard.html')">
              <i class="bi bi-house-door"></i>
              <span class="d-none d-sm-inline ms-2">Home</span>
            </a>
          </nav>

          <nav class="nav flex-column" id="navLinks">
            <a class="nav-link text-white nav-link-item active-link" onclick="loadIframe('dashboard.html')">
              <i class="bi bi-speedometer2"></i><span class="ms-2">Dashboard</span>
            </a>
            <a class="nav-link text-white nav-link-item" onclick="loadIframe('student.html')">
              <i class="bi bi-person-fill"></i><span class="ms-2">Student</span>
            </a>
            <a class="nav-link text-white nav-link-item" onclick="loadIframe('staff.html')">
              <i class="bi bi-people-fill"></i><span class="ms-2">Staff</span>
            </a>
            <a class="nav-link text-white nav-link-item" onclick="loadIframe('attendanceLog.html')">
              <i class="bi bi-calendar-check"></i><span class="ms-2">Attendance Logs</span>
            </a>
            <a class="nav-link text-white nav-link-item" onclick="loadIframe('device.html')">
              <i class="bi bi-device-hdd"></i><span class="ms-2">Devices</span>
            </a>
            <a class="nav-link text-white nav-link-item" onclick="loadIframe('user.html')">
              <i class="bi bi-person"></i><span class="ms-2">User</span>
            </a>
          </nav>
        </div>

        <div class="border-top pt-3">
          <a class="nav-link text-white text-center" href="#"><i class="bi bi-arrow-bar-right me-2"></i>Logout</a>
        </div>
      </div>

      <div class="col-12 col-md-9 col-lg-10 p-0">
        <main class="d-flex flex-column min-vh-100">

          <nav class="navbar navbar-expand-lg bg-body-tertiary px-3 mb-2">
            <div class="container-fluid d-flex justify-content-between align-items-center">
              <strong class="navbar-brand mb-0" id="pageTitle">Dashboard</strong>
              <div id="pageControls" class="d-flex align-items-center"></div>
            </div>
          </nav>

          <div id="backButtonContainer">
            <a href="#" id="backButton" class="btn btn-outline-dark">
              <i class="bi bi-arrow-left"></i> Back
            </a>
          </div>

          <iframe id="iframeContent" src="dashboard.html" class="flex-grow-1 w-100"></iframe>

        </main>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const iframe = document.getElementById('iframeContent');
    const navLinks = document.querySelectorAll('.nav-link-item');
    const pageTitle = document.getElementById('pageTitle');
    const pageControls = document.getElementById('pageControls');
    const backButton = document.getElementById('backButton');
    const backButtonContainer = document.getElementById('backButtonContainer');

    // MAPPING from URL to Page Title
    const pageTitles = {
        'dashboard.html': 'Dashboard',
        'student.html': 'Student',
        'staff.html': 'Staff',
        'attendanceLog.html': 'Attendance Logs',
        'device.html': 'Devices',
        'user.html': 'User',
        'addNewStudent.html': 'Add New Student',
        'addStaff.html': 'Add New Staff',
        'studentDetails.html': 'Student Details',
        'staffDetails.html': 'Staff Details'
    };

    function loadIframe(url) {
      iframe.src = url;
      const page = getPageKey(url);
      loadPageControls(page);
    }

    // Helper to determine page key
    function getPageKey(url) {
      if (url.includes("student.html")) return "student";
      if (url.includes("staff.html")) return "staff";
      return null;
    }

    // Function to load page-specific controls into navbar
    function loadPageControls(page) {
      pageControls.innerHTML = "";
      backButtonContainer.style.display = 'none';

      if (page === "student") {
        pageControls.innerHTML = `
          <a href="#" class="btn btn-primary me-3" onclick="loadIframe('addNewStudent.html')">Add New</a>
          <input id="searchClass" class="form-control me-2" type="search" placeholder="Class" style="max-width:120px;">
          <input id="searchSection" class="form-control me-2" type="search" placeholder="Section" style="max-width:120px;">
          <button class="btn btn-outline-primary me-2" type="button" onclick="filterStudentTable()">Search</button>
          <button class="btn btn-outline-secondary" type="button" onclick="resetStudentFilter()">Reset</button>
        `;
      }

      if (page === "staff") {
        pageControls.innerHTML = `
          <a href="#" class="btn btn-primary me-3" onclick="loadIframe('addStaff.html')">Add New</a>
          <input id="searchStaffId" class="form-control me-2" type="search" placeholder="Staff ID" style="max-width:120px;">
          <input id="searchDepartment" class="form-control me-2" type="search" placeholder="Department" style="max-width:120px;">
          <button class="btn btn-outline-primary me-2" type="button" onclick="filterStaffTable()">Search</button>
          <button class="btn btn-outline-secondary" type="button" onclick="resetStaffFilter()">Reset</button>
        `;
      }
    }

    // New functions to get search values and call the iframe's functions
    function filterStudentTable() {
        const searchClass = document.getElementById('searchClass').value;
        const searchSection = document.getElementById('searchSection').value;
        iframe.contentWindow.postMessage({ type: 'filterStudents', searchClass, searchSection }, '*');
    }

    function resetStudentFilter() {
        document.getElementById('searchClass').value = '';
        document.getElementById('searchSection').value = '';
        iframe.contentWindow.postMessage({ type: 'resetStudents' }, '*');
    }

    function filterStaffTable() {
        const searchStaffId = document.getElementById('searchStaffId').value;
        const searchDepartment = document.getElementById('searchDepartment').value;
        iframe.contentWindow.postMessage({ type: 'filterStaff', searchStaffId, searchDepartment }, '*');
    }

    function resetStaffFilter() {
        document.getElementById('searchStaffId').value = '';
        document.getElementById('searchDepartment').value = '';
        iframe.contentWindow.postMessage({ type: 'resetStaff' }, '*');
    }

    // Update active link on sidebar
    function updateActiveLink() {
      const currentPage = iframe.contentWindow.location.pathname.split('/').pop();
      navLinks.forEach(link => {
        link.classList.remove('active-link');
        if (link.href.includes(currentPage)) {
          link.classList.add('active-link');
        }
      });
    }

    // Use the iframe's history
    backButton.addEventListener("click", function (e) {
      e.preventDefault();
      iframe.contentWindow.history.back();
    });

    // Listen for messages from the iframe to update parent page
    window.addEventListener('message', function (event) {
      const data = event.data;
      if (data.type === 'updateTitle') {
        pageTitle.textContent = data.title;
        if (data.showBack) {
          backButtonContainer.style.display = 'block';
          pageControls.innerHTML = "";
        } else {
          backButtonContainer.style.display = 'none';
        }
      }
    });

    // Handle initial load and subsequent navigation within the iframe
    iframe.onload = function () {
      const currentPage = iframe.contentWindow.location.pathname.split('/').pop();
      updateActiveLink();
      
      const pageKey = getPageKey(currentPage);
      if (pageKey) {
        loadPageControls(pageKey);
        pageTitle.textContent = pageTitles[currentPage] || 'Dashboard';
      } else {
        pageControls.innerHTML = "";
        pageTitle.textContent = pageTitles[currentPage] || 'Page';
      }

      if (iframe.contentWindow.history.length > 1) {
        backButtonContainer.style.display = 'block';
      } else {
        backButtonContainer.style.display = 'none';
      }
    };
  </script>
</body>

</html>