<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Attendance Logs</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>

<body>
  <section class="p-3">
    <div class="card">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">Attendance</h5>
      </div>
      <div class="card-body">

        <div class="row mb-3">
          <div class="col-md-2">
            <input type="text" id="filterStudentId" class="form-control" placeholder="Student ID">
          </div>
          <div class="col-md-2">
            <input type="text" id="filterDeviceId" class="form-control" placeholder="Device ID">
          </div>
          <div class="col-md-2">
            <input type="text" id="filterDeviceName" class="form-control" placeholder="Device Name">
          </div>
          <div class="col-md-2">
            <input type="text" id="filterClass" class="form-control" placeholder="Class">
          </div>
          <div class="col-md-2">
            <input type="text" id="filterSection" class="form-control" placeholder="Section">
          </div>
          <div class="col-md-2">
            <select id="filterStatus" class="form-select">
              <option value="">All Status</option>
              <option value="Present">Present</option>
              <option value="Absent">Absent</option>
              <option value="Late">Late</option>
            </select>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>S.No</th>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Device ID</th>
                <th>Device Name</th>
                <th>Class</th>
                <th>Section</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ✅ Data from localStorage
    const students = JSON.parse(localStorage.getItem('students')) || [];
    const devices = [{
      class: "1",
      deviceId: "DEV-1",
      deviceName: "Class 1 Device"
    }, {
      class: "2",
      deviceId: "DEV-2",
      deviceName: "Class 2 Device"
    }, {
      class: "3",
      deviceId: "DEV-3",
      deviceName: "Class 3 Device"
    }, {
      class: "4",
      deviceId: "DEV-4",
      deviceName: "Class 4 Device"
    }, {
      class: "5",
      deviceId: "DEV-5",
      deviceName: "Class 5 Device"
    }, {
      class: "6",
      deviceId: "DEV-6",
      deviceName: "Class 6 Device"
    }, ];

    function loadAttendanceTable() {
      const tbody = document.getElementById("attendanceTableBody");
      tbody.innerHTML = "";
      const statusList = ["Present", "Absent", "Late"];

      let combinedData = students.map((stu, index) => {
        const device = devices.find(d => d.class === stu.class) || {};
        return {
          sno: index + 1,
          studentId: stu.studentId,
          studentName: stu.name,
          deviceId: device.deviceId || "-",
          deviceName: device.deviceName || "-",
          class: stu.class || "-",
          section: stu.section || "-",
          status: statusList[Math.floor(Math.random() * statusList.length)]
        };
      });

      const fStuId = document.getElementById("filterStudentId").value.toLowerCase();
      const fDevId = document.getElementById("filterDeviceId").value.toLowerCase();
      const fDevName = document.getElementById("filterDeviceName").value.toLowerCase();
      const fClass = document.getElementById("filterClass").value.toLowerCase();
      const fSec = document.getElementById("filterSection").value.toLowerCase();
      const fStatus = document.getElementById("filterStatus").value;

      combinedData = combinedData.filter(row =>
        (fStuId === "" || row.studentId.toLowerCase().includes(fStuId)) &&
        (fDevId === "" || row.deviceId.toLowerCase().includes(fDevId)) &&
        (fDevName === "" || row.deviceName.toLowerCase().includes(fDevName)) &&
        (fClass === "" || row.class.toLowerCase().includes(fClass)) &&
        (fSec === "" || row.section.toLowerCase().includes(fSec)) &&
        (fStatus === "" || row.status === fStatus)
      );

      combinedData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.sno}</td>
          <td>${row.studentId}</td>
          <td>${row.studentName}</td>
          <td>${row.deviceId}</td>
          <td>${row.deviceName}</td>
          <td>${row.class}</td>
          <td>${row.section}</td>
          <td>${row.status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Call this function when the page loads and on every filter change
    loadAttendanceTable();
    document.querySelectorAll("#filterStudentId, #filterDeviceId, #filterDeviceName, #filterClass, #filterSection, #filterStatus")
      .forEach(el => el.addEventListener("input", loadAttendanceTable));

    // ✅ Tell the parent to update the title
    if (window.parent) {
      window.parent.postMessage({
        type: 'updateTitle',
        title: 'Attendance Logs',
        showBack: false
      }, '*');
    }
  </script>
</body>

</html>